#Sprint 10/12 Deployment Runbook

|Sandbox|`Post refresh runbook for ALR-SP10/11'|
|-|-|
|Runbook Created|`2024-06-20`|
|Runbook Last Modified|`2024-07-9`|

## Pre-Requisites [5 min ]

1. [ ] Deployment User has assigned Permission Sets

> PERMISSION SET'S
   1.EHIS Data Migration PS
   2.EHIS Enable MFA PS
   3.Action Plans PS
   4.Document checklist PS
   5.DocGen Designer PS ,DocGen Designer PS ,Docgen Designer Standard User PS
   6.EHIS Admin User PS
   7.Business Milestones and Life Events Access PS

> Public Group
   1.ALR All Users PG
   2.ALR Data Analyst Users PG

> Permission Set Group
   1.EHIS ALR Admin PSG
   2.EHIS ALR Data Analyst PSG
   3.EHIS ALR Data Migration PSG
   4.EHIS System Administrator PSG

2. [ ] Checkout to `release-ALR-SP10/11` branch

## Assumptions

1. Total execution time ~ > 3 hrs

## Open Items

## Pre-Deployment Steps (1-2 hrs)

1.[ ] ALR-1263

- Go to Setup → search for User Interface → Enable “Use custom address fields" → Save.

2.[ ] ALR -1646 Add OWD email address and display name

- Setup -> Organization-Wide Addresses- Change Display Name from "Test" to "ALR Support Email"
   > Provide the below details:
   1. Display Name: Change Display Name to "ALR Support Email" and save it

3. [ ] In this step we are removing PS from PSG

- Go to Setup → search for Permission Set Group → Open below mentioned PSGs one after other

1.EHIS_Water_Business_Admin_PSG - "Remove EHIS_CRE_Group_Membership_PS permission set - click on done"
2.EHIS_Water_Public_Health_Engineer_PSG - "Remove EHIS_Read_Group_Membership_PS - click on done"
3.EHIS_Water_Officer_PSG - "Remove EHIS_Read_Group_Membership_PS - click on done"
    
4. [ ] ALR-1688 download excel from Jira

   1. Go to app launcher
   2. Select Salesforce Inspector->Data Export->Execute the below Query.
      Select  FolderId from EmailTemplate where Name ='Renewal Late Fee Notification Letter'
   3. Copy the FolderId of Name “Renewal Late Fee Notification Letter” from the export.
   4. Replace the folderId Column in Email Template-upcoming Renewal.csv to the copied Id from data export-> Save the file
   5. Select Salesforce Inspector->Data Import - Select the below:
      Action->Insert
   6. Object->Email Template , Copy and paste the content in Data Space and Import

5.[ ] ALR-1710

1. Go to SetUp->Search Deployment Settings->Enable “Allow deployments of components when corresponding Apex jobs are pending or in progress.

Caution: Enabling this option may cause Apex jobs to fail.” in Deployment Option
->Save" 

6.[ ] Destructive deployment -

1."Delete Physical_address__c from all the orgs.
2. Delete EHIS_CRE_Group_Membership_PS ,EHIS_Read_Group_Membership_PS

> sfdx force:source:deploy --manifest "destructive\destructive-post-refresh\package.xml" --postdestructivechanges "destructive\destructive-post-refresh\destructiveChanges.xml" --wait 30 -u gandloju.vishwantha@accenture.com.alr.uat

## Deployment Steps (20 mins)

1.[ ] Deploy OmniStudio components and its dependencies (5 min)
   > sfdx force:source:deploy --sourcepath "src\main\default\omniDataTransforms,src\main\default\omniIntegrationProcedures,src\main\default\omniUiCard,src\main\default\omniScripts,ehis-source\core\main\default\omniDataTransforms,ehis-source\core\main\default\omniScripts" --wait 30 -u gandloju.vishwantha@accenture.com.alr.uat


3.[ ]  Deploy full repository (~20 min)

> [ ] Verify folders
      |Folder|Path|
      |-|-|
      |`src`|`src\main\default`|
      |`src-access-mgmt`|`src-access-mgmt\main\default`|
      |`src-ui`|`src-ui\main\default`|
      |'Ehis-source'|

> [ ] Deploy

- sfdx force:source:deploy --sourcepath "ehis-source,src-access-mgmt\main\default,src-ui\main\default,src\main\default" --wait 30 -u gandloju.vishwantha@accenture.com.alr.uat -l RunLocalTests

>[ ] Re-activate Omnistudio components
      1. App Launcher -> OmniStudio -> Omnistudio **Integration Procedures**
      2. Locate all active custom **Integration Procedures** -> deactivate them -> activate them back.
      3. App Launcher -> OmniStudio -> **Omnistudio FlexCards**
      4. Locate all active custom **FlexCards** -> open each FlexCard -> deactivate -> activate back.
      5. App Launcher -> OmniStudio -> **OmniScripts**
      6. Locate all active custom **OmniScripts** -> open each omni script -> deactivate -> activate back

4.[ ] ALR-1199 Go to Omniscript “RiskAssessment“ → Open active version → deactivate and Click on dropdown and select “Select Deploy Standard Runtime Compatible LWC “ → Done

## Post-Deployment Steps (30 mins)

[ ] Create two records with EHIS Admin user

- "Login as EHIS Admin User and create 2 records mentioned below:

1.  Steps: Go to Apps → Search Party Role Relationship → click on New and give below details

> create first record with below details : 
- Role Name = “Downstream”
- Relationship Object Name = “Account Account Relationship”
- Related Inverse Record = “Upstream-Downstream-AAR” (First create record without adding this, then once second record created, edit and add the "Related Inverse" second record)
- Related Role Name = “Upstream”
- Create Inverse Role Automatically = "False" 
 
- Role Name = “Upstream”
- Relationship Object Name = “Account Account Relationship”
- Related Inverse Record = “Downstream-Upstream-AAR” (First create record without adding this, then once first record created, edit and add the "Related Inverse" second record)
- Related Role Name = “Downstream”
- Create Inverse Role Automatically = "False"

2. [ ] ALR-1729 download excel from Jira

- STEP 1: Go to app launcher
- STEP 2: Select Salesforce Inspector->Data Export->Execute the below Query.
  Select Id,FolderId from EmailTemplate where Name ='Renewal Late Fee Notification Letter'
- STEP 3 : Copy the Id,FolderId of Name “Renewal Late Fee Notification Letter” from the export.
- STEP 4 : Replace the folderId , ID Column in Email Template-upcoming Renewal.csv file 1 column to the copied Id from data export->Save the file
- STEP 5 : :Select Salesforce Inspector->Data Import.-Select the below:Select the below:

- Action->update
- Object->Email Template
- Copy and paste the content in Data Space and Import.

3. [ ] ALR-1700
- Log in to Salesforce.
- Go to Setup->Search “Scheduled Jobs”->Scheduled Apex.
- Provide the below details:
  > Job Name->Trigger Email on March-15
- Apex Class-> search and select “ScheduledEmailTrigger”
  > Select Cron Expression->”0 0 0 15 3 ?”
- Save

4. [ ] ALR-1701

- Log in to Salesforce.
- Go to Setup->Search “Scheduled Jobs”->Scheduled Apex.
- Provide the below details:
- Job Name->Trigger Email on Jan-15
- Apex Class-> search and select “ScheduleSendEmail” - Select Cron Expression->”0 0 0 15 1 ?” - Save

[ ] ALR-1712
- Schedule Jobs1:
1.Log in to Salesforce.
2.Go to Setup->Search “Scheduled Jobs”->Scheduled Apex.
3.Provide the below details:
Job Name->AccountStatusUpdateOnApril
Apex Class-> search and select “AccountStatusUpdate”
Select Cron Expression->0 0 0 1 4 ?
4.Save

- Schedule Jobs 2:
1.Log in to Salesforce.
2.Go to Setup->Search “Scheduled Jobs”->Scheduled Apex.
3.Provide the below details:
Job Name->AccountStatusUpdateOnMay
Apex Class-> search and select “AccountStatusUpdateOnMay”
Select Cron Expression->0 0 0 1 5 ?
4.Save

5. [ ] ALR-1710

- Go to SetUp->Search Deployment Settings->Enable “Allow deployments of components when corresponding Apex jobs are pending or in progress.
Caution: Enabling this option may cause Apex jobs to fail.” in Deployment Option
->Save" 

6. [ ] EHIS-1344

1. Login as System Administrator and click on setup icon
2. In Quick FInd section search for  State and Country/Territory Picklists
3. Open it and click on Configure States, Countries, and Territories
4. Change the Default Country/Territory to None "

DevOps checklist:

1. Validate the flows in org with Repo make sure active versions in branch which are deployed by devops should match in org
2. Email templates fieldS from csv uploaded properly
3. Check status of "Org wide email address" is verified
4. all the omnistudio components deployed from branch has the same status as branch
